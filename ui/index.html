<!DOCTYPE html>
<html>
  <head>
    <title>Call</title>

    <script>
      globalThis.notification = globalThis.notification || {};
      globalThis.notification.identity = "";
    </script>

    <style>
      .spinner {
        width: 48px;
        height: 48px;
        border: 5px solid lightgray;
        border-bottom-color: blue;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body style="margin: 0px">
    <div style="display: flex; justify-content: center">
      <div style="text-align: center">
        <h2 id="identity">Not logged in</h2>

        <input
          type="text"
          id="callee"
          name="callee"
          value="emrah"
          required
          style="width: 300px; height: 30px; padding: 4px"
        >

        <div id="spinner" style="display: none; margin: 30px">
          <span class="spinner"></span>
        </div>

        <button
          id="button-call"
          onclick="call()"
          style="display: block; margin: 30px auto; width: 80px; height: 30px"
          disabled
        >
          Call
        </button>

        <button
          id="button-cancel"
          onclick="cancel()"
          style="display: none; margin: 0px auto; width: 80px; height: 30px"
        >
          Cancel
        </button>
      </div>
    </div>

    <script>
      // -----------------------------------------------------------------------
      // Globals
      // -----------------------------------------------------------------------
      let callId = "";
      let ringCounter = 0;

      // -----------------------------------------------------------------------
      // call
      // -----------------------------------------------------------------------
      async function call() {
        document.getElementById("button-call").style.display = "none";
        document.getElementById("button-cancel").style.display =
          "block";
        document.getElementById("spinner").style.display = "block";

        const callee = document.getElementById("callee").value;
        const payload = {
          "callee_id": callee,
        };

        try {
          const url =
            "https://ics.nightly.opendesk.qa/intercom/call/add";
          const res = await fetch(url, {
            credentials: "include",
            headers: {
              Accept: "application/json",
            },
            method: "post",
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data?.call_id) throw "failed to start the call";

          callId = data.call_id;
          ringCounter = 0;
          setTimeout(ring, 1000);
        } catch {
          document.getElementById("button-call").style.display =
            "block";
          document.getElementById("button-cancel").style.display =
            "none";
          document.getElementById("spinner").style.display = "none";
        }
      }

      // -----------------------------------------------------------------------
      // ring
      // -----------------------------------------------------------------------
      async function ring() {
        try {
          if (!callId) throw "missing call id";
          if (ringCounter > 90) throw "cancelled call";
          if (ringCounter > 9) {
            cancel();
            throw "so many tries";
          }

          const url =
            "https://ics.nightly.opendesk.qa/intercom/call/ring";
          const payload = {
            "call_id": callId,
          };
          const res = await fetch(url, {
            credentials: "include",
            headers: {
              Accept: "application/json",
            },
            method: "post",
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          ringCounter += 1;
          setTimeout(ring, 1000);
        } catch {
          document.getElementById("button-call").style.display =
            "block";
          document.getElementById("button-cancel").style.display =
            "none";
          document.getElementById("spinner").style.display = "none";
        }
      }

      // -----------------------------------------------------------------------
      // cancel
      // -----------------------------------------------------------------------
      async function cancel() {
        try {
          ringCounter = 99;
          document.getElementById("button-cancel").style.display =
            "none";

          if (!callId) throw "missing call id";

          const url =
            "https://ics.nightly.opendesk.qa/intercom/call/stop";
          const payload = {
            "call_id": callId,
          };
          const res = await fetch(url, {
            credentials: "include",
            headers: {
              Accept: "application/json",
            },
            method: "post",
            body: JSON.stringify(payload),
          });
          const data = await res.json();
        } catch {
          // Do nothing.
        }
      }
    </script>

    <script src="silent-login.js"></script>
    <script src="notification.js"></script>
  </body>
</html>
